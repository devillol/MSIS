# Моделирование нижней геосферы земли
Босинзон Галина, 734 группа
## Код
Основной код, используемый для выполнения проекта, лежит в директории `python_code`

### Функция create_dataset
```python
def create_grouped_dataset(mat_file: str, param: str, filter_expr='1 = 1') -> DataFrame:
    """
    Функция, генерирующая из .mat-файла датафрэйм для параметра, отбирая записи по условию
    :param mat_file: путь к .mat файлу
    :param param: какой параметр считаем (Temperature или M)
    :param filter_expr: условие
    :return: DataFrame
    """
```
Функция создает датасет из `.mat`-файла, в котором сырые данные файла пересчитаны
в нужные значения `season`, `region`, `SZA` и `F107`. 
На выходе датасет дополнен значениями температуры или концентрации нейтралов (в
зависимости от переданного значения `param`), а также отобраны только нужные записи
с помощью фильтра `filter_expr`

Расчет значений `season`, `region`, `SZA` и `F107` и фильтрация производятся
с помощью sql-запроса:

```sql
    select * from (
    select 
    case when month in (11, 12, 1) and shirota > 0 
            or month in (5, 6, 7) and shirota < 0 then 'зима'
        when month in (2, 3, 4) and shirota > 0
            or month in (8, 9, 10) and shirota < 0 then 'весна'
        when month in (5, 6, 7) and shirota > 0 
            or month in (11, 12, 1) and shirota < 0 then 'лето'
        when month in (8, 9, 10) and shirota > 0
            or month in (2, 3, 4) and shirota < 0 then 'осень'
    end season
    , case when abs(shirota) > 60 then 'полярные'
          when abs(shirota) < 30 then 'экваториальные'
         else 'средние'
    end region
    , case when F107 < 100 then 'низкаяСА'
        when F107 > 150 then 'высокаяСА'
        else 'средняяСА'
    end F107
    , case when SZA < 60 then 'день'
        when SZA > 100 then 'ночь'
        else 'сумерки'
    end SZA
    {%- for col_name in column_names %}
    , {{col_name}}
    {%- endfor %}
    from summary
    ) t where {{filter_query}}
```

### Класс KdeBuilder

```python
class KdeBuilder:
    """
    Класс для визуализации данных
    """

    def __init__(self, mat_file, param, **kwargs):
```
При инициализации передаются параметры:
* `mat_file` - путь к файлу с исходными данными
* `param` - что рассчитываем (`Temperature` или `M`)
* `**kwargs` - значения `season`, `region`, `SZA` и `F107` , если по ним нужен отбор

Во время инициализации создается датасет из файла.

Для построения графика необходимо вызвать метод `create_plot`

```python
    def create_plot(self, file, x_label=None, y_label='Высота, км'):
        """
        Метод, строящий график
        :param file: куда сохранять файл
        :param x_label: подпись оси x
        :param y_label: подпись оси y
        :return:
        """
```

### Утилита cli.py
Сделана для удобства вызова построения графиков

Вызывается с опциями, соответствующими критериям фильтра.

```sh
usage: cli.py [OPTIONS] PARAM
```

`PARAM` - `T` или `M` в зависимости от того, что мы хотим рассчитать

`OPTIONS`:

|Опция| возможные значения |
|-----|------|
|--season|лето, зима, осень, весна|
|--region|экваториальные, средние, полярные|
|--sza|день, ночь, сумерки|
|--f107|низкаяСА, высокаяСА, средняяСА|
 
_Примеры:_

* Построеение графика плотности вероятности температуры нейтралов летом в полярных широтных, днем, при низкой солнечной активности

```sh 
$ python3 cli.py T --season лето --region полярные --sza день --f107 низкаяСА
```

* Построение графика плотности вероятности концентрации нейтралов зимой в средних широтах (для всех времен суток и СА):

```shell 
$ python3 cli.py M --season зима --region средние
```

**График сохраняется в директории `images` c названием**
```python 
f'images/{param}-{"-".join([value for value in kwargs.values() if value])}.png'
```
## Исходные данные
Наблюдения со спутника AURA лежат в файле `data/data.mat`

Также в папке `data` лежат эти данные в текстовом виде

Изобразим распределения данных по _сезонам, регионам, временам суток и солнечной активности_:

```shell script
$ python3 python_code/create_data_hist.py --param season
$ python3 python_code/create_data_hist.py --param region
$ python3 python_code/create_data_hist.py --param SZA
$ python3 python_code/create_data_hist.py --param F107
```

![](images/data_season.png)
![](images/data_region.png)
![](images/data_SZA.png)
![](images/data_F107.png)
## Распределение плотностей вероятностей T и M от условий
В этом разделе будем строить распределения плотности вероятности T и M и графики зависимостей
среднего и наиболее вероятного значения этих параметров от высоты h при различных гелиофизических условиях,
а так же графики зависимостей этих величин от гелиофизических условий.

На иллюстрациях этого раздела слева будут изображены распределения плотности вероятности величины,
нормированной на максимальное значение, а справа - графики среднего и наиболее
вероятного значения величины.

### Зависимость от солнечной активности
Рассмотрим, как изменится распределение вероятности температуры нейтралов летним днем в экваториальных широтах 
в зависимости от солнечной активности:

![](images/by_h/T-лето-экваториальные-день-высокаяСА.png)
![](images/by_h/T-лето-экваториальные-день-низкаяСА.png)

Дисперсия значений при высокой СА больше, чем при низкой. Возможно, это связано с меньшим количеством наблюдений.
Тем не менее, наиболее вероятные значения близки к средним.

Сравним еще распределения летним днем в средних широтах:

![](images/by_h/T-лето-средние-день-высокаяСА.png)
![](images/by_h/T-лето-средние-день-низкаяСА.png)

Наблюдаем аналогичную картину: средние значения при высокой и низкой СА расходятся не
значительно, но разброс значений при высокой СА больше, чем при низкой. 

Проверим сказанное выше, построив зависимость распределения температуры нейтралов от солнечной активности
(например, на высоте h= 50 км)
![](images/by_f107/T50-лето-экваториальные-день.png)
![](images/by_f107/T50-лето-средние-день.png)

Для обоих регионов наблюдается минимум при f107 около 140, но в целом четкой зависимости 
температуры от солнечной активности не наблюдается.


Теперь построим в этих же условиях распределение плотности вероятности концентрации нейтралов:

![](images/by_h/M-лето-экваториальные-день-высокаяСА.png)
![](images/by_h/M-лето-экваториальные-день-низкаяСА.png)

![](images/by_h/M-лето-средние-день-высокаяСА.png)
![](images/by_h/M-лето-средние-день-низкаяСА.png)

При высокой СА разброс значений больше, чем при низкой. При этом, во всех случаях наиболее вероятные
значения совпадают со средними.

Построим зависимость распределения концентрации нейтралов на высоте h = 50 км и h = 80 км
от солнечной активноости.

![](images/by_f107/M80-зима-экваториальные-ночь.png)
![](images/by_f107/M50-лето-полярные-сумерки.png)

Колебания концентрации не значительны.

>**_Вывод:_**  
>* распределение P(M) от солнечной активности практически не зависит
>* среднее значение T от солнечной активности зависит не существенно, однако,
>вероятностное распределение P(T) немного меняется в зависимости от СА


### Зависимость от времени суток
Так как была выявлена зависимость распределения плотности вероятности температуры от солнечной активности,
необходимо снова проверять зависимость распределения плотности вероятности температуры от времени суток 
при замороженных  остальных параметрах. Больше всего наблюдений летом на экваторе 
при низкой СА, при этих параметрах и будем проверять:

![](images/by_h/T-лето-экваториальные-день-низкаяСА.png)
![](images/by_h/T-лето-экваториальные-ночь-низкаяСА.png)

В обоих случаях количество наблюдений большое, и картинки наблюдаются схожие.
Кроме того, наиболее вероятные значения практически совпадают со средними.

Построим зависимости распределения температуры нейтралов на высоте h = 60 км и 85 км
от зенитного угла:

![](images/by_sza/T60-осень-полярные-низкаяСА.png)
![](images/by_sza/T85-зима-средние-низкаяСА.png)
![](images/by_sza/T85-осень-экваториальные-низкаяСА.png)

Однако, эти графики показывают, что все же зависимость температуры от зенитного угла существует.

На этих же данных посмотрим распределение вероятности концентрации нейтралов

![](images/by_h/M-лето-экваториальные-день-низкаяСА.png)
![](images/by_h/M-лето-экваториальные-ночь-низкаяСА.png)

Наиболее вероятные значения совпадают со средними, и картинки с первого взгляда кажутся
одинаковыми. При этом, наблюдается, что дисперсия значений растет при увеличении высоты.

Построим зависимость распределения концетрации нейтралов от зенитного угла

![](images/by_sza/M60-осень-полярные-низкаяСА.png)
![](images/by_sza/M80-лето-средние-низкаяСА.png)
![](images/by_sza/M80-лето-экваториальные-низкаяСА.png)

Зависимость наиболее вероятной концентрации от зенитного угла наблюдается, но не существенно


### Зависимость от широты
Построим распределение плотности вероятности температуры нейтралов в летний день
при низкой СА для экваториальных, средних и полярных широт

![](images/by_h/T-лето-экваториальные-день-низкаяСА.png)
![](images/by_h/T-лето-средние-день-низкаяСА.png)
![](images/by_h/T-лето-полярные-день-низкаяСА.png)

Заметим, что разброс значений температуры возрастает при приближении к полярным широтам, а
различия в распределениях видны невооруженным взглядом.

Кроме того, наиболее вероятные значения не совпадают со средними, особенно в средних широтах.

Подтвердим выше сказанные утверждения с помощью графиков распределения T на высотах h = 55 км,
60 км и 80 км от месяца. Будем рассматривать только наблюдения из северного полушария, так как
сезонность зависит от полушария.

![](images/by_month/T55-полярные-низкаяСА.png)
![](images/by_month/T60-экваториальные-ночь-низкаяСА.png)
![](images/by_month/T80-средние-день-низкаяСА.png)

Зависимость температуры от месяца подтвердилась.

Для распределения плотности вероятности концентрации нейтралов:

![](images/by_h/M-лето-экваториальные-день-низкаяСА.png)
![](images/by_h/M-лето-средние-день-низкаяСА.png)
![](images/by_h/M-лето-полярные-день-низкаяСА.png)

Разброс значений концентрации нейтралов так же увеличивается при приближении к 
полярным широтам.

Наиболее вероятные значения концентрации снова близки к средним, но уже различия более заметны, чем 
в предыдущих случаях.


### Зависимость от сезона
Рассмотрим зиму и лето в полярных широтах при низкой СА (время суток опустим, так как в
этих широтах все лето и всю зиму время суток не меняется, да и выше было доказано, что от
времени суток распределения практически не зависят):

![](images/by_h/T-зима-полярные-низкаяСА.png)
![](images/by_h/T-лето-полярные-низкаяСА.png)

Сезонная зависимость температуры ярко выражена.

Проверим еще для четырех времен года в средних широтах:

![](images/by_h/T-зима-средние-день-низкаяСА.png)
![](images/by_h/T-лето-средние-день-низкаяСА.png)
![](images/by_h/T-осень-средние-день-низкаяСА.png)
![](images/by_h/T-весна-средние-день-низкаяСА.png)

Самый большой разброс температур наблюдается зимой, наименьший - летом.

_Этот эксперимент подтверждает так же предыдущее утверждение о широтной зависимости
распределения плотности вероятности температуры (в полярных широтах более заметна
разница между зимним и летним распределением)_

Проверим сезонную зависимость распределения плотности концентрации нейтралов:

![](images/by_h/M-зима-полярные-низкаяСА.png)
![](images/by_h/M-лето-полярные-низкаяСА.png)

Зимой разброс значений больше, чем летом

![](images/by_h/M-зима-средние-день-низкаяСА.png)
![](images/by_h/M-лето-средние-день-низкаяСА.png)
![](images/by_h/M-осень-средние-день-низкаяСА.png)
![](images/by_h/M-весна-средние-день-низкаяСА.png)

Опять же, наибольший разброс получился зимой, а наименьший - летом.

>**_Вывод:_**  
>Распределения P(T) и P(M) зависят от сезона


